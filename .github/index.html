<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pregnancy Pal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8B5CF6; /* Violet-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-backdrop { background-color: rgba(0,0,0,0.7); }
        .tab-active { border-bottom-color: #8B5CF6; color: #8B5CF6; }
        .category-btn-active { background-color: #8B5CF6; color: white; }
        textarea:read-only, input:read-only {
            background-color: #f9fafb; /* gray-50 */
            cursor: default;
        }
    </style>
</head>
<body class="bg-violet-50 text-gray-800">

    <div id="app-container" class="container mx-auto max-w-2xl p-4 sm:p-6 md:p-8 min-h-screen">
        <!-- Header -->
        <header class="text-center mb-6 flex justify-between items-center">
            <div></div> <!-- Spacer -->
            <div class="flex-grow">
                 <h1 class="text-4xl sm:text-5xl font-bold text-violet-700">Pregnancy Pal</h1>
                 <p class="text-gray-600 mt-2">Your AI-powered safety checker for pregnancy.</p>
            </div>
            <button id="logout-button" class="hidden bg-white text-violet-600 border border-violet-200 text-sm font-bold py-2 px-4 rounded-lg hover:bg-violet-50 transition">
                Logout
            </button>
        </header>

        <!-- Auth View -->
        <div id="auth-view">
            <div class="bg-white p-8 rounded-2xl shadow-md">
                <h2 id="auth-title" class="text-2xl font-bold text-center text-gray-800 mb-6">Welcome! Sign In</h2>
                <form id="auth-form">
                    <div class="mb-4"><label for="email" class="block text-gray-700 font-medium mb-2">Email Address</label><input type="email" id="auth-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500" required></div>
                    <div class="mb-6"><label for="password" class="block text-gray-700 font-medium mb-2">Password</label><input type="password" id="auth-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500" required></div>
                    <button type="submit" id="auth-submit-button" class="w-full bg-violet-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-violet-700 transition">Sign In</button>
                </form>
                <p id="auth-error" class="text-red-500 text-sm mt-4 text-center min-h-[2.5rem]"></p>
                <p class="text-center text-sm text-gray-600 mt-4"><span id="auth-prompt-text">Don't have an account?</span><button id="auth-toggle-button" class="font-semibold text-violet-600 hover:underline">Sign Up</button></p>
            </div>
        </div>

        <!-- Main App View (Initially Hidden) -->
        <div id="main-app-view" class="hidden">
            <!-- Tabs -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex -mb-px" aria-label="Tabs">
                    <button data-tab="search" class="tab-btn w-1/3 py-4 px-1 text-center border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300 tab-active">Search</button>
                    <button data-tab="categories" class="tab-btn w-1/3 py-4 px-1 text-center border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">Categories</button>
                    <button data-tab="notes" class="tab-btn w-1/3 py-4 px-1 text-center border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">Notes</button>
                </nav>
            </div>

            <!-- Main Content -->
            <main>
                <!-- Search View -->
                <div id="search-view" class="tab-view">
                    <div class="bg-white p-6 rounded-2xl shadow-md mb-8">
                        <label for="search-input" class="block text-lg font-semibold text-gray-700 mb-2">What are you curious about?</label>
                        <p class="text-sm text-gray-500 mb-4">Enter an item, or scan a product's barcode.</p>
                        <form id="search-form" class="flex flex-col sm:flex-row gap-3"><input type="text" id="search-input" class="flex-grow w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 transition" placeholder="e.g., 'Soft cheese'"><button type="submit" id="search-button" class="w-full sm:w-auto bg-violet-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-violet-700 transition-transform transform active:scale-95">Check</button></form>
                        <div class="mt-4 text-center"><button id="scan-button" class="w-full sm:w-auto bg-white border border-violet-600 text-violet-600 font-bold py-3 px-6 rounded-lg hover:bg-violet-50 flex items-center justify-center mx-auto"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><line x1="7" y1="12" x2="17" y2="12"/></svg>Scan Barcode</button></div>
                    </div>
                    <div id="results-container" class="space-y-6">
                         <div id="initial-message" class="text-center text-gray-500 bg-white/60 p-8 rounded-2xl shadow-sm"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mx-auto text-violet-400 mb-4"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg><p class="font-medium">Results will appear here.</p><p class="text-sm">Ready when you are!</p></div>
                    </div>
                    <div id="loader" class="hidden justify-center items-center py-10"><div class="loader"></div><p id="loader-text" class="ml-4 text-gray-600 font-medium">Searching...</p></div>
                    <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert"><strong class="font-bold">Oops!</strong><span id="error-text" class="block sm:inline">Something went wrong.</span></div>
                </div>

                <!-- Categories View -->
                <div id="categories-view" class="hidden tab-view space-y-8">
                    <div class="bg-white p-4 rounded-2xl shadow-md">
                        <div id="category-filters" class="flex flex-wrap gap-2 justify-center">
                            <button data-category="all" class="category-btn px-4 py-2 text-sm font-semibold rounded-full border border-violet-200 transition category-btn-active">All</button>
                            <button data-category="food" class="category-btn px-4 py-2 text-sm font-semibold rounded-full border border-violet-200 transition">Food & Drink</button>
                            <button data-category="medication" class="category-btn px-4 py-2 text-sm font-semibold rounded-full border border-violet-200 transition">Medication</button>
                            <button data-category="activity" class="category-btn px-4 py-2 text-sm font-semibold rounded-full border border-violet-200 transition">Activities</button>
                            <button data-category="cosmetic" class="category-btn px-4 py-2 text-sm font-semibold rounded-full border border-violet-200 transition">Cosmetics</button>
                             <button data-category="unassigned" class="category-btn px-4 py-2 text-sm font-semibold rounded-full border border-violet-200 transition">Uncategorized</button>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Safe Items</h2>
                        <div id="categories-safe-list" class="space-y-4"></div>
                    </div>
                     <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Items to Avoid</h2>
                        <div id="categories-avoid-list" class="space-y-4"></div>
                    </div>
                </div>

                <!-- Notes View -->
                <div id="notes-view" class="hidden tab-view">
                    <div class="text-right mb-6">
                        <button id="add-note-button" class="bg-violet-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-violet-700 transition">Add New Note</button>
                    </div>
                    <div id="notes-list" class="space-y-4"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- All Modals -->
    <div id="scanner-modal" class="modal-backdrop fixed inset-0 z-50 flex-col items-center justify-center hidden"><div class="bg-white rounded-2xl shadow-2xl p-4 sm:p-6 w-11/12 max-w-lg"><h2 class="text-xl font-bold text-center mb-4">Scan Product Barcode</h2><div id="reader" class="w-full rounded-lg overflow-hidden border"></div><button id="close-scanner" class="mt-4 w-full bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button></div></div>
    <div id="save-item-modal" class="modal-backdrop fixed inset-0 z-50 flex-col items-center justify-center hidden"><div class="bg-white rounded-2xl shadow-2xl p-6 w-11/12 max-w-lg"><h2 id="save-item-title" class="text-xl font-bold mb-4">Save Item</h2><form id="save-item-form"><div class="mb-4"><label for="item-category" class="block font-medium mb-2">Category</label><select id="item-category" class="w-full px-4 py-2 border rounded-lg"><option value="unassigned">Uncategorized</option><option value="food">Food & Drink</option><option value="medication">Medication</option><option value="activity">Activity</option><option value="cosmetic">Cosmetic</option></select></div><div class="mb-6"><label for="personal-note" class="block font-medium mb-2">Personal Note (Optional)</label><textarea id="personal-note" rows="3" class="w-full px-4 py-2 border rounded-lg" placeholder="e.g., Doctor said this is okay..."></textarea></div><div class="flex gap-4"><button type="button" id="cancel-save-item" class="w-full bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button><button type="submit" class="w-full bg-violet-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-violet-700 transition">Save</button></div></form></div></div>
    <div id="note-modal" class="modal-backdrop fixed inset-0 z-50 flex-col items-center justify-center hidden"><div class="bg-white rounded-2xl shadow-2xl p-6 w-11/12 max-w-lg"><h2 id="note-modal-title" class="text-xl font-bold mb-4">Add Note</h2><form id="note-form"><div class="mb-4" id="note-title-container"><label id="note-title-label" for="note-title" class="block font-medium mb-2">Title</label><input type="text" id="note-title" class="w-full px-4 py-2 border rounded-lg" required></div><div class="mb-4"><label id="note-details-label" for="note-details" class="block font-medium mb-2">Details</label><textarea id="note-details" rows="5" class="w-full px-4 py-2 border rounded-lg"></textarea></div><div class="mb-6" id="note-photo-container"><label for="note-photo-input" class="block font-medium mb-2">Add Photo</label><input type="file" id="note-photo-input" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/><img id="note-image-preview" src="" class="hidden mt-4 rounded-lg max-h-48 w-auto mx-auto"><div id="note-upload-progress" class="hidden mt-2 w-full bg-gray-200 rounded-full h-2.5"><div class="bg-violet-600 h-2.5 rounded-full" style="width: 0%"></div></div></div><div class="flex gap-4"><button type="button" id="cancel-note" class="w-full bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 transition">Cancel</button><button type="button" id="edit-note-button" class="w-full bg-violet-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-violet-700 transition hidden">Edit</button><button type="submit" id="save-note-button" class="w-full bg-violet-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-violet-700 transition">Save Note</button></div><button type="button" id="delete-note-button" class="hidden text-red-500 hover:underline mt-4 mx-auto block">Delete Note</button></form></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, updateDoc, serverTimestamp, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Config and Initialization ---
        const firebaseConfig = {
          apiKey: "AIzaSyCt-dsrXMDcONnbypHC9uTmaoCml-iAszo",
          authDomain: "pregnancy-pal---app.firebaseapp.com",
          projectId: "pregnancy-pal---app",
          storageBucket: "pregnancy-pal---app.firebasestorage.app",
          messagingSenderId: "960191272770",
          appId: "1:960191272770:web:9314a393600e1e2b3ddadb",
          measurementId: "G-ELGC1V4DWD"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const appId = firebaseConfig.appId || 'default-app-id';
        
        // --- State Variables ---
        let userId;
        let savedItemsUnsubscribe = null, notesUnsubscribe = null;
        let savedItemsCache = [], notesCache = [];
        let currentTab = 'search';
        let activeCategoryFilter = 'all';
        let html5QrCode;
        let isLoginMode = true;
        let currentResultData = null; // To hold data for the save modal
        let currentSaveStatus = null; // 'safe' or 'avoid'
        let currentEditingNote = null; // To hold note data for editing

        // --- DOM Elements ---
        const authView = document.getElementById('auth-view');
        const mainAppView = document.getElementById('main-app-view');
        const logoutButton = document.getElementById('logout-button');
        const authForm = document.getElementById('auth-form');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const authTitle = document.getElementById('auth-title');
        const authSubmitButton = document.getElementById('auth-submit-button');
        const authToggleButton = document.getElementById('auth-toggle-button');
        const authPromptText = document.getElementById('auth-prompt-text');
        const authError = document.getElementById('auth-error');
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const resultsContainer = document.getElementById('results-container');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const initialMessage = document.getElementById('initial-message');
        const scanButton = document.getElementById('scan-button');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabViews = document.querySelectorAll('.tab-view');
        const scannerModal = document.getElementById('scanner-modal');
        const closeScannerButton = document.getElementById('close-scanner');
        
        // Categories View
        const categoryFilters = document.getElementById('category-filters');
        const categoriesSafeList = document.getElementById('categories-safe-list');
        const categoriesAvoidList = document.getElementById('categories-avoid-list');

        // Notes View
        const addNoteButton = document.getElementById('add-note-button');
        const notesList = document.getElementById('notes-list');

        // Modals
        const saveItemModal = document.getElementById('save-item-modal');
        const saveItemForm = document.getElementById('save-item-form');
        const saveItemTitle = document.getElementById('save-item-title');
        const itemCategory = document.getElementById('item-category');
        const personalNote = document.getElementById('personal-note');
        const cancelSaveItem = document.getElementById('cancel-save-item');
        
        const noteModal = document.getElementById('note-modal');
        const noteModalTitle = document.getElementById('note-modal-title');
        const noteForm = document.getElementById('note-form');
        const noteTitle = document.getElementById('note-title');
        const noteTitleContainer = document.getElementById('note-title-container');
        const noteTitleLabel = document.getElementById('note-title-label');
        const noteDetails = document.getElementById('note-details');
        const noteDetailsLabel = document.getElementById('note-details-label');
        const notePhotoInput = document.getElementById('note-photo-input');
        const notePhotoContainer = document.getElementById('note-photo-container');
        const noteImagePreview = document.getElementById('note-image-preview');
        const noteUploadProgress = document.getElementById('note-upload-progress');
        const cancelNote = document.getElementById('cancel-note');
        const saveNoteButton = document.getElementById('save-note-button');
        const editNoteButton = document.getElementById('edit-note-button');
        const deleteNoteButton = document.getElementById('delete-note-button');

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                authView.classList.add('hidden');
                mainAppView.classList.remove('hidden');
                logoutButton.classList.remove('hidden');
                listenForSavedItems();
                listenForNotes();
            } else {
                userId = null;
                authView.classList.remove('hidden');
                mainAppView.classList.add('hidden');
                logoutButton.classList.add('hidden');
                if (savedItemsUnsubscribe) savedItemsUnsubscribe();
                if (notesUnsubscribe) notesUnsubscribe();
            }
        });

        authToggleButton.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            authTitle.textContent = isLoginMode ? 'Welcome! Sign In' : 'Create an Account';
            authSubmitButton.textContent = isLoginMode ? 'Sign In' : 'Sign Up';
            authPromptText.textContent = isLoginMode ? "Don't have an account?" : "Already have an account?";
            authToggleButton.textContent = isLoginMode ? 'Sign Up' : 'Sign In';
            authError.innerHTML = '';
        });

        authForm.addEventListener('submit', async e => {
            e.preventDefault();
            const email = authEmail.value;
            const password = authPassword.value;
            authError.innerHTML = '';
            try {
                if (isLoginMode) {
                    await setPersistence(auth, browserLocalPersistence);
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                console.error("Auth error:", error.code, error.message);
                if (error.code === 'auth/configuration-not-found') {
                     authError.innerHTML = 'Auth error: Go to your <a href="https://console.firebase.google.com/" target="_blank" class="underline">Firebase Console</a>, select Authentication > Sign-in method, and enable the Email/Password provider.';
                } else {
                    let userMessage = error.message.replace('Firebase: ', '').replace(/ \(.*/, '');
                    authError.textContent = "Error: " + userMessage;
                }
            }
        });

        logoutButton.addEventListener('click', () => signOut(auth));

        // --- FIRESTORE LISTENERS ---
        function listenForSavedItems() {
             if (savedItemsUnsubscribe) savedItemsUnsubscribe();
            const savedItemsRef = collection(db, `artifacts/${appId}/users/${userId}/savedItems`);
            savedItemsUnsubscribe = onSnapshot(savedItemsRef, snapshot => {
                savedItemsCache = snapshot.docs.map(doc => ({ ...doc.data(), firestoreId: doc.id }));
                if (currentTab === 'categories') renderCategoriesView();
                const currentResultId = document.querySelector('.summary-card')?.dataset.resultId;
                if (currentResultId) updateSaveIcons(currentResultId);
            });
        }
        function listenForNotes() {
             if (notesUnsubscribe) notesUnsubscribe();
            const notesRef = collection(db, `artifacts/${appId}/users/${userId}/notes`);
            notesUnsubscribe = onSnapshot(query(notesRef), snapshot => {
                notesCache = snapshot.docs.map(doc => ({ ...doc.data(), firestoreId: doc.id })).sort((a, b) => b.createdAt?.toMillis() - a.createdAt?.toMillis());
                if (currentTab === 'notes') renderNotesView();
            });
        }

        // --- TAB NAVIGATION ---
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.dataset.tab;
                currentTab = tabName;
                
                tabButtons.forEach(btn => btn.classList.remove('tab-active'));
                button.classList.add('tab-active');

                tabViews.forEach(view => view.classList.add('hidden'));
                document.getElementById(`${tabName}-view`).classList.remove('hidden');

                if(tabName === 'categories') renderCategoriesView();
                if(tabName === 'notes') renderNotesView();
            });
        });

        // --- SEARCH VIEW ---
        searchForm.addEventListener('submit', e => { e.preventDefault(); handleManualSearch(searchInput.value.trim()); });
        scanButton.addEventListener('click', startScanner);
        closeScannerButton.addEventListener('click', stopScanner);

        async function handleManualSearch(query) {
             if (!query) return;
            startLoading('Searching the web for you...');
            try {
                const userQuery = `Using the provided search results, please summarize the general consensus on whether "${query}" is safe to consume, use, or do during pregnancy.`;
                const { text, sources } = await callGeminiAPI(userQuery);
                const resultData = { id: Date.now(), title: `Is "${query}" safe?`, summary: text, sources: sources };
                renderResults(resultData);
            } catch (error) { showError('The AI search failed. Please try again.'); console.error('API Call failed:', error); } 
            finally { stopLoading(); }
        }

        async function handleBarcodeScan(barcode) {
            stopScanner();
            startLoading('Barcode found! Looking up product...');
            try {
                const product = await getProductFromBarcode(barcode);
                if (!product || !product.product_name) { showError(`Could not find a product for barcode ${barcode}.`); stopLoading(); return; }
                if (!product.ingredients_text_with_allergens) { showError(`Product "${product.product_name}" has no ingredient list.`); stopLoading(); return; }
                loaderText.textContent = 'Analyzing ingredients with AI...';
                const userQuery = `Analyze ingredients for "${product.product_name}" for pregnancy safety. Ingredients: "${product.ingredients_text_with_allergens}"`;
                const { text, sources } = await callGeminiAPI(userQuery);
                const resultData = { id: Date.now(), title: `Analysis for "${product.product_name}"`, summary: text, sources: sources };
                renderResults(resultData);
            } catch (error) { showError('Failed to look up product information.'); console.error('Barcode lookup failed:', error); } 
            finally { stopLoading(); }
        }

        async function getProductFromBarcode(barcode) {
            const apiUrl = `https://world.openfoodfacts.org/api/v2/product/${barcode}.json`;
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            return data.product;
        }

        async function callGeminiAPI(userQuery) {
            const apiKey = "AIzaSyBUeF_oDLecNh-pSPpzyn-Cs4Juxvx0Q1w";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const systemPrompt = `You are Pregnancy Pal, a cautious AI assistant. Summarize web search results about safety for pregnant women. Rules: 1. Base summary ONLY on provided Google Search results. 2. Be clear, balanced, and easy to understand. 3. If sources conflict, state it. 4. Use neutral language. 5. **Do NOT give direct medical advice.** 6. Keep summary to 1-2 concise paragraphs.`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }], tools: [{ "google_search": {} }], systemInstruction: { parts: [{ text: systemPrompt }] } };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            const candidate = result.candidates?.[0];
            if (!candidate?.content?.parts?.[0]?.text) throw new Error("Invalid API response");
            const text = candidate.content.parts[0].text;
            let sources = [];
            const groundingMetadata = candidate.groundingMetadata;
            if (groundingMetadata?.groundingAttributions) {
                sources = groundingMetadata.groundingAttributions.map(attr => ({ uri: attr.web?.uri, title: attr.web?.title })).filter(s => s.uri && s.title);
            }
            return { text, sources: Array.from(new Map(sources.map(item => [item['uri'], item])).values()) };
        }

        function startScanner() {
            scannerModal.style.display = 'flex';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, (decodedText) => handleBarcodeScan(decodedText))
                .catch(err => { showError("Could not start camera. Please check permissions."); stopScanner(); });
        }
        function stopScanner() {
            if (html5QrCode?.isScanning) html5QrCode.stop();
            scannerModal.style.display = 'none';
        }
        
        // --- SAVE ITEM LOGIC ---
        function handleSaveClick(resultData, status) {
            const existingItem = savedItemsCache.find(item => item.id === resultData.id);
            if (existingItem && existingItem.status === status) {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/savedItems`, existingItem.firestoreId);
                deleteDoc(docRef);
            } else {
                currentResultData = resultData;
                currentSaveStatus = status;
                openSaveItemModal(existingItem);
            }
        }
        
        function openSaveItemModal(existingItem) {
            saveItemTitle.textContent = `Save as "${currentSaveStatus.charAt(0).toUpperCase() + currentSaveStatus.slice(1)}"`;
            personalNote.value = existingItem?.note || '';
            itemCategory.value = existingItem?.category || 'unassigned';
            saveItemModal.style.display = 'flex';
        }

        saveItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const existingItem = savedItemsCache.find(item => item.id === currentResultData.id);
            
            const itemData = {
                ...currentResultData,
                status: currentSaveStatus,
                category: itemCategory.value,
                note: personalNote.value.trim()
            };

            if (existingItem) {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/savedItems`, existingItem.firestoreId);
                await updateDoc(docRef, itemData);
            } else {
                const savedItemsRef = collection(db, `artifacts/${appId}/users/${userId}/savedItems`);
                await addDoc(savedItemsRef, itemData);
            }
            saveItemModal.style.display = 'none';
        });

        cancelSaveItem.addEventListener('click', () => saveItemModal.style.display = 'none');

        // --- CATEGORIES VIEW ---
        categoryFilters.addEventListener('click', (e) => {
            if(e.target.tagName === 'BUTTON') {
                activeCategoryFilter = e.target.dataset.category;
                document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('category-btn-active'));
                e.target.classList.add('category-btn-active');
                renderCategoriesView();
            }
        });

        function renderCategoriesView() {
            const filteredItems = savedItemsCache.filter(item => activeCategoryFilter === 'all' || item.category === activeCategoryFilter);
            const safeItems = filteredItems.filter(item => item.status === 'safe');
            const avoidItems = filteredItems.filter(item => item.status === 'avoid');
            
            categoriesSafeList.innerHTML = '';
            categoriesAvoidList.innerHTML = '';

            const emptySafeMessage = `<div class="text-center text-gray-500 bg-white/60 p-8 rounded-2xl shadow-sm"><p class="font-medium">No safe items saved in this category.</p></div>`;
            const emptyAvoidMessage = `<div class="text-center text-gray-500 bg-white/60 p-8 rounded-2xl shadow-sm"><p class="font-medium">No avoided items saved in this category.</p></div>`;

            if (safeItems.length === 0) { categoriesSafeList.innerHTML = emptySafeMessage; }
            else { safeItems.forEach(item => categoriesSafeList.appendChild(createSavedItemCard(item))); }

            if (avoidItems.length === 0) { categoriesAvoidList.innerHTML = emptyAvoidMessage; }
            else { avoidItems.forEach(item => categoriesAvoidList.appendChild(createSavedItemCard(item))); }
        }

        function createSavedItemCard(item) {
            const itemCard = document.createElement('div');
            itemCard.className = 'bg-white p-4 rounded-xl shadow-md cursor-pointer';
            itemCard.innerHTML = `
                <div class="flex items-center justify-between">
                    <p class="font-semibold text-gray-800 capitalize truncate">${item.title}</p>
                    <button data-firestore-id="${item.firestoreId}" class="unsave-btn flex-shrink-0 ml-4 p-2 text-gray-400 hover:text-red-500 rounded-full transition">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
                ${item.note ? `<p class="text-sm text-gray-600 mt-2 pt-2 border-t">Note: ${item.note}</p>` : ''}
            `;
            
            itemCard.addEventListener('click', (e) => {
                if(e.target.closest('.unsave-btn')) {
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/savedItems`, e.target.closest('.unsave-btn').dataset.firestoreId);
                    deleteDoc(docRef);
                } else {
                    tabButtons.forEach(btn => btn.dataset.tab === 'search' ? btn.click() : null);
                    renderResults(item);
                }
            });
            return itemCard;
        }

        // --- NOTES VIEW ---
        addNoteButton.addEventListener('click', () => openNoteModal());
        
        function renderNotesView() {
            notesList.innerHTML = '';
            if (notesCache.length === 0) {
                 notesList.innerHTML = `<div class="text-center text-gray-500 bg-white/60 p-8 rounded-2xl shadow-sm"><p class="font-medium">No notes yet.</p><p class="text-sm">Click 'Add New Note' to get started.</p></div>`;
                 return;
            }
            notesCache.forEach(note => notesList.appendChild(createNoteCard(note)));
        }

        function createNoteCard(note) {
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-xl shadow-md cursor-pointer';
            const noteDate = note.createdAt?.toDate ? new Date(note.createdAt.toDate()).toLocaleDateString() : 'Just now';
            card.innerHTML = `<h3 class="font-semibold text-gray-800">${note.title}</h3>
                <p class="text-sm text-gray-500">${noteDate}</p>`;
            card.addEventListener('click', () => openNoteModal(note));
            return card;
        }
        
        function setNoteModalMode(mode) {
            const isEditMode = mode === 'edit';
            noteTitle.readOnly = !isEditMode;
            noteDetails.readOnly = !isEditMode;
            
            // Show/hide labels and containers based on mode
            noteTitleContainer.style.display = isEditMode ? 'block' : 'none';
            noteDetailsLabel.style.display = isEditMode ? 'block' : 'none';

            notePhotoContainer.style.display = isEditMode ? 'block' : 'none';
            saveNoteButton.classList.toggle('hidden', !isEditMode);
            editNoteButton.classList.toggle('hidden', isEditMode);
        }

        function openNoteModal(note = null) {
            currentEditingNote = note;
            noteForm.reset();
            noteImagePreview.classList.add('hidden');
            noteImagePreview.src = '';
            noteUploadProgress.classList.add('hidden');

            if (note) { // Viewing/Editing existing note
                noteModalTitle.textContent = note.title;
                noteTitle.value = note.title;
                noteDetails.value = note.details;
                if (note.imageUrl) {
                    noteImagePreview.src = note.imageUrl;
                    noteImagePreview.classList.remove('hidden');
                }
                deleteNoteButton.classList.remove('hidden');
                cancelNote.textContent = 'Close';
                setNoteModalMode('view');
            } else { // Adding a new note
                noteModalTitle.textContent = 'Add New Note';
                deleteNoteButton.classList.add('hidden');
                cancelNote.textContent = 'Cancel';
                setNoteModalMode('edit');
            }
            noteModal.style.display = 'flex';
        }
        
        editNoteButton.addEventListener('click', () => {
             noteModalTitle.textContent = 'Edit Note';
             setNoteModalMode('edit');
        });

        noteForm.addEventListener('submit', handleNoteFormSubmit);
        cancelNote.addEventListener('click', () => noteModal.style.display = 'none');
        deleteNoteButton.addEventListener('click', handleDeleteNote);
        notePhotoInput.addEventListener('change', (e) => {
             const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => noteImagePreview.src = event.target.result;
                reader.readAsDataURL(file);
                noteImagePreview.classList.remove('hidden');
            }
        });

        async function handleNoteFormSubmit(e) {
            e.preventDefault();
            const file = notePhotoInput.files[0];
            let imageUrl = currentEditingNote?.imageUrl || '';
            let imagePath = currentEditingNote?.imagePath || '';

            if (file) {
                if (imagePath) {
                    const oldImageRef = ref(storage, imagePath);
                    try { await deleteObject(oldImageRef); } catch(e) { console.error("Old image deletion failed, it might not exist.", e); }
                }
                const uploadResult = await uploadNotePhoto(file);
                imageUrl = uploadResult.url;
                imagePath = uploadResult.path;
            }

            const noteData = {
                title: noteTitle.value,
                details: noteDetails.value,
                imageUrl,
                imagePath,
                createdAt: currentEditingNote?.createdAt || serverTimestamp(),
                updatedAt: serverTimestamp()
            };

            if (currentEditingNote) {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/notes`, currentEditingNote.firestoreId);
                await updateDoc(docRef, noteData);
            } else {
                const notesRef = collection(db, `artifacts/${appId}/users/${userId}/notes`);
                await addDoc(notesRef, noteData);
            }
            noteModal.style.display = 'none';
        }

        async function handleDeleteNote() {
            if (!currentEditingNote) return;
            if (confirm('Are you sure you want to delete this note?')) {
                if (currentEditingNote.imagePath) {
                    const imageRef = ref(storage, currentEditingNote.imagePath);
                    try { await deleteObject(imageRef); } catch(e) { console.error("Image deletion failed.", e); }
                }
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/notes`, currentEditingNote.firestoreId);
                await deleteDoc(docRef);
                noteModal.style.display = 'none';
            }
        }

        async function uploadNotePhoto(file) {
            const filePath = `artifacts/${appId}/users/${userId}/notes_images/${Date.now()}-${file.name}`;
            const storageRef = ref(storage, filePath);
            const uploadTask = uploadBytesResumable(storageRef, file);

            noteUploadProgress.classList.remove('hidden');

            return new Promise((resolve, reject) => {
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        noteUploadProgress.querySelector('div').style.width = progress + '%';
                    }, 
                    (error) => {
                        console.error('Upload failed:', error);
                        reject(error);
                    }, 
                    () => {
                        getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                            resolve({ url: downloadURL, path: filePath });
                        });
                    }
                );
            });
        }


        // --- UI & RENDERING HELPERS ---
        function renderResults(resultData) {

            resultsContainer.innerHTML = '';
            const summaryCard = document.createElement('div');
            summaryCard.className = 'bg-white p-6 rounded-2xl shadow-md relative summary-card flex flex-col';
            summaryCard.dataset.resultId = resultData.id;

            // Button container: always visible, top right
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'absolute top-4 right-4 flex space-x-2 z-10';
            const saveButton = document.createElement('button');
            saveButton.id = `save-btn-${resultData.id}`;
            saveButton.className = 'text-red-500 hover:text-red-600 transition-transform active:scale-90 bg-white rounded-full shadow p-1 border border-gray-200';
            saveButton.style.width = '40px';
            saveButton.style.height = '40px';
            saveButton.onclick = () => handleSaveClick(resultData, 'safe');
            const avoidButton = document.createElement('button');
            avoidButton.id = `avoid-btn-${resultData.id}`;
            avoidButton.className = 'text-gray-500 hover:text-gray-700 transition-transform active:scale-90 bg-white rounded-full shadow p-1 border border-gray-200';
            avoidButton.style.width = '40px';
            avoidButton.style.height = '40px';
            avoidButton.onclick = () => handleSaveClick(resultData, 'avoid');
            buttonContainer.appendChild(saveButton);
            buttonContainer.appendChild(avoidButton);
            summaryCard.appendChild(buttonContainer);

            // Main content
            const contentDiv = document.createElement('div');
            contentDiv.className = 'pr-20'; // add right padding so text doesn't go under icons
            contentDiv.innerHTML = `<h2 class="text-2xl font-bold text-gray-800 mb-4 capitalize">${resultData.title}</h2><p class="text-gray-700 leading-relaxed whitespace-pre-wrap">${resultData.summary}</p>`;
            summaryCard.appendChild(contentDiv);
            resultsContainer.appendChild(summaryCard);
            updateSaveIcons(resultData.id);

            if (resultData.sources && resultData.sources.length > 0) {
                const sourcesCard = document.createElement('div');
                sourcesCard.className = 'bg-white p-6 rounded-2xl shadow-md';
                sourcesCard.innerHTML = `<h3 class="text-xl font-semibold text-gray-800 mb-4">Information Sources</h3><ul class="space-y-3">${resultData.sources.map(s => `<li><a href="${s.uri}" target="_blank" rel="noopener noreferrer" class="text-violet-600 hover:underline hover:text-violet-800 transition block truncate">${s.title}</a></li>`).join('')}</ul>`;
                resultsContainer.appendChild(sourcesCard);
            }

            const disclaimerCard = document.createElement('div');
            disclaimerCard.className = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-r-lg';
            disclaimerCard.innerHTML = `<p class="font-bold">Important Disclaimer</p><p class="mt-1 text-sm">This information is generated by AI from web search results and is for informational purposes only. It is not medical advice. Always consult with your doctor or a qualified healthcare professional for any health concerns or before making any decisions related to your pregnancy.</p>`;
            resultsContainer.appendChild(disclaimerCard);
        }
        
        function updateSaveIcons(resultId) {
            const savedItem = savedItemsCache.find(item => item.id == resultId);
            const isSafe = savedItem?.status === 'safe';
            const isAvoid = savedItem?.status === 'avoid';
            const saveBtn = document.getElementById(`save-btn-${resultId}`);
            const avoidBtn = document.getElementById(`avoid-btn-${resultId}`);
            if (saveBtn) saveBtn.innerHTML = getHeartIcon(isSafe);
            if (avoidBtn) avoidBtn.innerHTML = getAvoidIcon(isAvoid);
        }

        function startLoading(text) {
            searchButton.disabled = true; scanButton.disabled = true;
            resultsContainer.innerHTML = '';
            initialMessage.classList.add('hidden'); errorMessage.classList.add('hidden');
            loader.style.display = 'flex'; loaderText.textContent = text;
        }
        function stopLoading() {
            loader.style.display = 'none';
            searchButton.disabled = false; scanButton.disabled = false;
        }
        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function getHeartIcon(isSaved) {
            const solid = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-7 h-7"><path d="M9.653 16.915l-.005-.003-.019-.01a20.759 20.759 0 01-1.162-.682 22.045 22.045 0 01-2.582-1.9-22.247 22.247 0 01-2.694-2.336c-.48-.564-.93-1.144-1.29-1.762A7.5 7.5 0 012.5 8.5c0-4.142 3.358-7.5 7.5-7.5s7.5 3.358 7.5 7.5c0 1.345-.352 2.62-.973 3.738a22.507 22.507 0 01-1.222 1.662 22.247 22.247 0 01-2.694 2.336 22.049 22.049 0 01-2.582 1.9 20.753 20.753 0 01-1.182.682z" /></svg>`;
            const outline = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg>`;
            return isSaved ? solid : outline;
        }
        
        function getAvoidIcon(isSaved) {
             const solid = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-7 h-7"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM6.75 9.25a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5z" clip-rule="evenodd" /></svg>`;
            const outline = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>`;
             return isSaved ? solid : outline;
        }
    </script>
</body>
</html>


